<html>
  <head>
    <title>CV</title>
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="http://momentjs.com/downloads/moment-with-locales.min.js" charset="utf-8"></script>
    <script src="cv2json.js" charset="utf-8"></script>

    
    <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

    <link href='style.css' rel='stylesheet' type='text/css'>
  </head>
  <body>
    <h1>Work and Code Experience</h1>
    <a class="link" href="cv.pdf">pdf</a>
    <a class="link" href="https://github.com/andrejlamov/cv">repo</a>
    <svg id="timeline"></svg>
    <p id="description"></p>
  </body>
  <script>

   d3.text('./cv.org', function(cv) {
       var data = cv2json(cv);
       var d = data['Education'].d
                                      .concat(data['Work Experience'].d)
                                      .concat(data['Programming Experience'].d)
                                      .concat(data['Hobby Projects'].d);
       timeline('#timeline', d);

   });
   
   function timeline(id, data) {

       var freeze = false;
       
       var color = d3.scale.category20();
       
       var x = d3.time.scale();
       
       var y = d3.scale.ordinal();
       
       var x_axis = d3.svg.axis()
                      .scale(x)
                      .orient("bottom")
                      .tickFormat(d3.time.format('%y'));
           
       var y_axis = d3.svg.axis()
                      .scale(y)
                      .orient("right");
       
       var svg = d3.select(id);
       

       var min_date = d3.min(data, function(d) { return d.start });
       var max_date = d3.max(data, function(d) { return d.stop });
           
       x.domain([min_date, max_date]);
       y.domain(data.map(function(d) { return d.title }));
           
       svg.on('click', function() {
           d3.select(this)
               .transition()
               .style('opacity', freeze ? 1 : 0.5);
           d3.select('#description')
               .transition()
               .style('font-size', freeze ? '18px' : '22px');
           freeze = !freeze;
       }).selectAll('.job')
          .data(data)
          .enter()
          .append('g')
          .on('mouseover', function(d, i) {
              if(freeze) return;
              
              d3.select('#description').html(d.description);
          })
          .on('mouseout', function(d) {
              if(freeze) return;
              
              d3.select('#description').text("");
          })
          .attr('class', 'job')
          .append('rect')
          .attr('fill', function(d) {
              return color(d.title);
          })
          .attr('opacity', function(d) {
              return 0.7;
          });
       
       svg.append('g')
          .attr('class', 'y axis');
       
       svg.append('g')
          .attr('class', 'x axis');
       
       var resize = function() {
           
           var padding = 40;
           
           var width  = parseInt(d3.select(id).style('width')) - padding - 400;
           var height  = parseInt(d3.select(id).style('height')) - padding;
           
           x.range([padding, width]);
           
           y.rangeRoundBands([padding, height], .1);
           
           d3.select(id + ' .x.axis')
             .attr('transform', 'translate(0,' + height + ')')
             .call(x_axis);
           d3.select(id + ' .y.axis')
             .attr('transform', function(_,i) {
                 return 'translate(' + width + ',0)'
             })
             .call(y_axis);


           d3.selectAll(id + ' .y.axis .tick')
             .attr('transform', function(_, i) {
                 var d = data[i];
                 var fst = d3.select(this).attr('transform');
                 var tx = -(width - x(d.stop));
                 return fst + ' translate(' + tx + ',0)'
             })
           
           d3.selectAll(id + ' .job')
             .attr('transform', function(d) {
                 return 'translate(' + x(d.start) + ',' + y(d.title) + ')';
             });
           
           d3.selectAll(id + ' .job rect')
             .attr('height', y.rangeBand)
             .attr('width', function(d) {
                 return x(d.stop) - x(d.start);
             });
       };
       
       resize();

       d3.selectAll(id + ' .y.axis .tick')
         .on('mouseover', function(_,i) {
             if(freeze) return;
             
             var d = d3.selectAll(id + ' .job ').data()[i];
             d3.select('#description').html(d.description);
         })
         .on('mouseout', function(d,i) {
             if(freeze) return;

             d3.select('#description').text("");
         });

       d3.select(window).on('resize', resize);
   };
  </script>
</html>
